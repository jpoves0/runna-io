# ğŸ”„ Flujos de SincronizaciÃ³n: Apple Watch â†’ Runna.io

**Diagramas visuales de cada opciÃ³n**

---

## ğŸ“Š Flujo Actual: Manual (Requiere clic)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SEMANA DE RUNNING CON APPLE WATCH                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Lunes                     Jueves                      Domingo
  â”‚                        â”‚                            â”‚
  â–¼                        â–¼                            â–¼
â”Œâ”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”                     â”Œâ”€â”€â”€â”€â”€â”
â”‚ 5km â”‚                 â”‚ 10kmâ”‚                     â”‚ 15kmâ”‚
â”‚ Run â”‚                 â”‚ Run â”‚                     â”‚ Run â”‚
â””â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”˜
  â”‚                        â”‚                            â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Strava     â”‚
                    â”‚ Sincroniza   â”‚
                    â”‚ automÃ¡ticam. â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ Actividades en      â”‚
                â”‚ Strava Cloud (âœ…)   â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                     â”‚
                â–¼                     â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Usuario â”‚          â”‚ Actividades    â”‚
            â”‚ abre    â”‚          â”‚ visibles en    â”‚
            â”‚ Runna.ioâ”‚          â”‚ Strava Web (âœ…)â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Perfil â†’ Integraciones
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Click: "Importar de  â”‚
            â”‚ Strava"              â”‚
            â”‚ âš ï¸ PASO MANUAL      â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Runna.io Backend:    â”‚
            â”‚ â€¢ Obtiene actividadesâ”‚
            â”‚ â€¢ Decodifica route   â”‚
            â”‚ â€¢ Crea territorio    â”‚
            â”‚ â€¢ Actualiza ranking  â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ âœ… Mapa actualizado  â”‚
            â”‚ 30km conquistados    â”‚
            â”‚ Ranking: #3          â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â±ï¸ Tiempo total: Manual (30 minutos a dÃ­as)
âš ï¸ FricciÃ³n: Requiere acciÃ³n del usuario
```

---

## ğŸš€ Flujo Propuesto 1: Webhooks de Strava (RECOMENDADO)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ USUARIO COMPLETA ACTIVIDAD EN APPLE WATCH                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Apple Watch ğŸ“±       â”‚
    â”‚ â€¢ GPS capturando...  â”‚
    â”‚ â€¢ Frecuencia cardÃ­acaâ”‚
    â”‚ â€¢ Datos de movimientoâ”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ "Actividad completada"
          â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Strava App (Watch)   â”‚
    â”‚ â€¢ Recibe datos       â”‚
    â”‚ â€¢ Calcula mÃ©tricas   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ Sincroniza automÃ¡ticamente
          â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Strava Cloud â˜ï¸      â”‚
    â”‚ â€¢ Almacena actividad â”‚
    â”‚ â€¢ Disponible en API  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ Webhook notification
          â”‚ (InstantÃ¡neo)
          â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Runna.io Backend (Cloudflare Worker)     â”‚
    â”‚ POST /api/webhooks/strava                â”‚
    â”‚ â€¢ Recibe notificaciÃ³n                    â”‚
    â”‚ â€¢ Valida origen (verify token)           â”‚
    â”‚ â€¢ Obtiene detalles de actividad          â”‚
    â”‚ â€¢ Decodifica polyline (ruta)             â”‚
    â”‚ â€¢ Calcula territorio conquistado         â”‚
    â”‚ â€¢ Actualiza BD                           â”‚
    â”‚ â€¢ Calcula reconquistas de otros usuarios â”‚
    â”‚ â€¢ Genera eventos para notificaciones      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ âœ… BD Actualizada     â”‚
    â”‚ â€¢ Actividad creada    â”‚
    â”‚ â€¢ Territorio creado   â”‚
    â”‚ â€¢ Ranking calculado   â”‚
    â”‚ â€¢ Eventos registrados â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ Push notification
          â”‚ (instantÃ¡neo)
          â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ iPhone Usuario ğŸ“±    â”‚
    â”‚ NotificaciÃ³n:        â”‚
    â”‚ "Â¡Territorio         â”‚
    â”‚ conquistado!"        â”‚
    â”‚ "5km | 45min"        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Usuario abre Runna.ioâ”‚
    â”‚ Mapa ya actualizado  â”‚
    â”‚ â€¢ Nueva ruta visible â”‚
    â”‚ â€¢ Territorios teÃ±idosâ”‚
    â”‚ â€¢ Ranking actualizadoâ”‚
    â”‚ âœ… LISTO             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â±ï¸ Tiempo total: ~30 segundos (automÃ¡tico)
âœ… FricciÃ³n: CERO (100% automÃ¡tico)
ğŸ¯ Experiencia: Excelente (notificaciÃ³n en tiempo real)
```

---

## ğŸ“Š Comparativa de Flujos

### Flujo Actual (Manual)
```
Actividad en Apple Watch
        â†“
Esperar a que usuario vuelva a abrir Runna.io
        â†“
Navigate a Perfil â†’ Integraciones
        â†“
Click "Importar de Strava"
        â†“
Esperar procesamiento
        â†“
Ver cambios

â±ï¸ Peor caso: 24 horas
âœ‹ Requiere acciÃ³n: SÃ
```

### Flujo con Webhooks (Propuesto)
```
Actividad en Apple Watch
        â†“
Webhook de Strava â†’ Runna.io
        â†“
Procesamiento automÃ¡tico
        â†“
BD actualizada
        â†“
NotificaciÃ³n push al usuario
        â†“
Usuario abre Runna.io (cuando quiera)
        â†“
Todo ya actualizado

â±ï¸ Latencia: 5-30 segundos
âœ‹ Requiere acciÃ³n: NO
```

---

## ğŸ”„ Flujo Completo: De Actividad a Territorio

```
ENTRADA: Webhook de Strava
â”‚
â”‚ {
â”‚   "object_type": "activity",
â”‚   "aspect_type": "create",
â”‚   "owner_id": 12345,
â”‚   "object_id": 67890
â”‚ }
â”‚
â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. VALIDACIÃ“N                       â”‚
â”‚ â€¢ Verificar verify_token            â”‚
â”‚ â€¢ Confirmar que es actividad        â”‚
â”‚ â€¢ Buscar usuario en BD              â”‚
â”‚ â€¢ Obtener token vÃ¡lido de Strava    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ âœ… ValidaciÃ³n OK
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. OBTENER DETALLES                â”‚
â”‚ â€¢ Llamar Strava API: /activities/IDâ”‚
â”‚ â€¢ Recibir:                          â”‚
â”‚   - name: "Morning Run"             â”‚
â”‚   - distance: 5234 (metros)         â”‚
â”‚   - moving_time: 2340 (segundos)   â”‚
â”‚   - start_date: "2026-02-03T08:15" â”‚
â”‚   - map.summary_polyline: "encoded"â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ âœ… Detalles obtenidos
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. PROCESAR POLYLINE                â”‚
â”‚ â€¢ Decodificar polyline de Strava    â”‚
â”‚ â€¢ Obtener array de coordenadas      â”‚
â”‚   [                                  â”‚
â”‚     [40.7128, -74.0060],  // NYC    â”‚
â”‚     [40.7129, -74.0061],            â”‚
â”‚     [40.7130, -74.0062],            â”‚
â”‚     ...                              â”‚
â”‚   ]                                  â”‚
â”‚ â€¢ Validar >2 puntos                 â”‚
â”‚ â€¢ Validar distancia >100m           â”‚
â”‚ â€¢ Validar duraciÃ³n >60s             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ âœ… Polyline vÃ¡lido
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. CREAR RUTA EN BD                 â”‚
â”‚ INSERT routes {                     â”‚
â”‚   id: "abc123",                     â”‚
â”‚   userId: "user456",                â”‚
â”‚   name: "Morning Run",              â”‚
â”‚   coordinates: JSON.stringify(...), â”‚
â”‚   distance: 5234,                   â”‚
â”‚   duration: 2340,                   â”‚
â”‚   startedAt: timestamp,             â”‚
â”‚   completedAt: timestamp            â”‚
â”‚ }                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ âœ… Ruta creada
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. CALCULAR TERRITORIO              â”‚
â”‚ â€¢ Crear polÃ­gono desde polyline     â”‚
â”‚ â€¢ Buffer de 10m alrededor           â”‚
â”‚ â€¢ Simplificar polÃ­gono              â”‚
â”‚ â€¢ Calcular Ã¡rea en mÂ²               â”‚
â”‚   = 23456 mÂ²                        â”‚
â”‚ â€¢ Convertir a GeoJSON               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ âœ… Territorio calculado
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. GUARDAR TERRITORIO EN BD         â”‚
â”‚ INSERT territories {                â”‚
â”‚   id: "ter789",                     â”‚
â”‚   userId: "user456",                â”‚
â”‚   routeId: "abc123",                â”‚
â”‚   geometry: GeoJSON,                â”‚
â”‚   area: 23456,                      â”‚
â”‚   conqueredAt: timestamp            â”‚
â”‚ }                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ âœ… Territorio guardado
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. VERIFICAR RECONQUISTAS           â”‚
â”‚ â€¢ Buscar otros territorios que      â”‚
â”‚   solapan con este                  â”‚
â”‚ â€¢ Para cada solapamiento:           â”‚
â”‚   - Calcular % conquistado          â”‚
â”‚   - Si >50% = territorio reconquistado
â”‚   - Transferir ownership            â”‚
â”‚   - Crear evento de reconquista     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ âœ… Reconquistas detectadas
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. ACTUALIZAR RANKING               â”‚
â”‚ â€¢ Recalcular total de usuario:      â”‚
â”‚   new_total = sum(territories.area) â”‚
â”‚ â€¢ Recalcular rankings globales      â”‚
â”‚ â€¢ Actualizar leaderboard            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ âœ… Ranking actualizado
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9. GENERAR NOTIFICACIONES           â”‚
â”‚ â€¢ Crear evento en tabla de eventos  â”‚
â”‚ â€¢ Push notification al usuario      â”‚
â”‚   "Â¡Conquistaste 2.3 hectÃ¡reas!"   â”‚
â”‚ â€¢ Email de resumen (opcional)       â”‚
â”‚ â€¢ Notificar usuarios reconquistados â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ âœ… Notificaciones enviadas
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 10. RESPONDER AL WEBHOOK            â”‚
â”‚ HTTP 200 OK                         â”‚
â”‚ {                                   â”‚
â”‚   "status": "ok",                   â”‚
â”‚   "processed": true,                â”‚
â”‚   "territory_area": 23456,          â”‚
â”‚   "reconquests": 0,                 â”‚
â”‚   "processing_time_ms": 234         â”‚
â”‚ }                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
SALIDA: Todo completado en <500ms
```

---

## ğŸ® Experiencia del Usuario (Antes vs DespuÃ©s)

### ANTES (Manual)
```
Lunes 8:00 AM
â”‚
â”œâ”€ Corro 5km con Strava en Apple Watch
â”‚
â”œâ”€ 8:30 AM: Vuelvo a casa
â”‚  â””â”€ Actividad visible en Strava
â”‚
â”œâ”€ ... pasan horas ...
â”‚
â”œâ”€ Martes 10:00 PM (34 horas despuÃ©s)
â”‚  â””â”€ Me acuerdo de Runna.io
â”‚
â”œâ”€ Abro app
â”œâ”€ Voy a Perfil
â”œâ”€ Hago clic en "Importar de Strava"
â”œâ”€ Espero procesamiento
â”‚
â””â”€ Finalmente veo la ruta en el mapa

â±ï¸ Delay: 34+ horas
ğŸ˜ Experiencia: Desconectada
```

### DESPUÃ‰S (Webhooks)
```
Lunes 8:00 AM
â”‚
â”œâ”€ Corro 5km con Strava en Apple Watch
â”‚
â”œâ”€ 8:00:30 AM
â”‚  â””â”€ Webhook activado
â”‚
â”œâ”€ 8:00:35 AM
â”‚  â”œâ”€ Push notification: "Â¡5km conquistados!"
â”‚  â””â”€ Mapa actualizado en background
â”‚
â”œâ”€ Abro app en el momento
â”‚  â””â”€ Territorio ya visible
â”‚
â””â”€ Veo mis amigos rechazando/defendiendo territorio

â±ï¸ Delay: 30 segundos
ğŸ˜Š Experiencia: Tiempo real y atractiva
```

---

## ğŸ” ValidaciÃ³n de Seguridad

```
Strava â†’ Runna.io (Webhook)

1. Strava envÃ­a POST a https://runna.io/api/webhooks/strava
   
2. Headers validados:
   âœ… X-Strava-Signature (aunque simple)
   âœ… TLS/SSL (HTTPS obligatorio)
   
3. Body contiene:
   - object_type (verificado = "activity")
   - aspect_type (verificado = "create" o "update")
   - owner_id (usado para buscar usuario)
   - object_id (ID de actividad en Strava)
   
4. Runna.io valida:
   âœ… Existe usuario con ese Strava ID
   âœ… Usuario tiene token vÃ¡lido
   âœ… Token no ha expirado
   
5. Si pasa validaciones:
   âœ… Procesa actividad
   âœ… Retorna HTTP 200 OK
   
6. Si falla validaciÃ³n:
   âœ… Retorna HTTP 401 o 403
   âœ… Strava reintenta (hasta 8 veces)

âš ï¸ Rate limiting implementado
âš ï¸ DeduplicaciÃ³n implementada
âš ï¸ Logging de todos los webhooks
```

---

## ğŸ“ˆ MÃ©tricas de Rendimiento

```
Webhook Processing Benchmark:

Actividad simple (5km, 20 minutos):
  â€¢ ValidaciÃ³n: 10ms
  â€¢ Obtener detalles: 150ms (HTTP call a Strava)
  â€¢ Procesar polyline: 50ms
  â€¢ Crear ruta: 30ms
  â€¢ Calcular territorio: 100ms
  â€¢ Guardar territorio: 30ms
  â€¢ Verificar reconquistas: 50ms
  â€¢ Actualizar ranking: 40ms
  â€¢ Notificaciones: 80ms
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  TOTAL: ~540ms
  
Actividad larga (20km, 120 minutos):
  â€¢ Similar pero con polyline mÃ¡s larga
  â€¢ Calcular territorio: 200ms (mÃ¡s puntos)
  â€¢ Verificar reconquistas: 150ms (mÃ¡s territorios)
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  TOTAL: ~800ms

Limits:
  âœ… <1 segundo es aceptable
  âœ… <100ms serÃ­a ideal
  âœ… Strava no espera respuesta inmediata
  âœ… Timeout de Strava: ~30 segundos (seguro)
```

---

## âœ… ImplementaciÃ³n Checklist

```
FASE 1: Desarrollo
â–¡ Crear endpoint POST /api/webhooks/strava
â–¡ Crear endpoint GET /api/webhooks/strava (validaciÃ³n)
â–¡ Implementar funciÃ³n processStravaActivities()
â–¡ Agregar helper getValidStravaToken()
â–¡ Configurar logging/monitoring
â–¡ Tests unitarios
â–¡ Tests de integraciÃ³n

FASE 2: Deployment
â–¡ Generar STRAVA_WEBHOOK_VERIFY_TOKEN
â–¡ Agregar a wrangler.toml
â–¡ Deploy a staging
â–¡ Validar en staging
â–¡ Deploy a production
â–¡ Configurar alertas

FASE 3: Registro
â–¡ Registrar webhook con Strava API
â–¡ O configurar en Strava Settings
â–¡ VerificaciÃ³n: Test webhook

FASE 4: Testing en ProducciÃ³n
â–¡ Usuario hace actividad
â–¡ Webhook se recibe
â–¡ Actividad aparece en Runna.io
â–¡ NotificaciÃ³n enviada
â–¡ Territorio visible en mapa
â–¡ Ranking actualizado

FASE 5: ComunicaciÃ³n
â–¡ Actualizar UI (ya no necesita botÃ³n)
â–¡ DocumentaciÃ³n de usuario
â–¡ Blog post explicando feature
â–¡ Email a usuarios existentes
```

---

**Diagrama preparado**: Febrero 3, 2026  
**VersiÃ³n**: 1.0  
**Status**: Completo âœ…
